<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>DATARADAR</title>
    <style>
        :root {
            --bg: #000;
            --card: #1c1c1e;
            --text: #fff;
            --dim: #8e8e93;
            --accent: #0a84ff;
            --green: #30d158;
            --orange: #ff9f0a;
            --red: #ff453a;
            --border: #38383a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app {
            max-width: 430px;
            margin: 0 auto;
            min-height: 100vh;
            padding-bottom: 90px;
        }

        /* Header */
        .header {
            padding: 60px 20px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header .time {
            font-size: 13px;
            color: var(--dim);
            margin-top: 4px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 0 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--card);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: 600;
        }

        .stat-card .label {
            font-size: 11px;
            color: var(--dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .stat-card.green .value { color: var(--green); }
        .stat-card.orange .value { color: var(--orange); }
        .stat-card.red .value { color: var(--red); }

        /* Section */
        .section {
            padding: 0 16px;
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
        }

        .section-action {
            font-size: 15px;
            color: var(--accent);
            background: none;
            border: none;
            cursor: pointer;
        }

        /* Search */
        .search-bar {
            background: var(--card);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .search-bar svg {
            width: 18px;
            height: 18px;
            color: var(--dim);
            flex-shrink: 0;
        }

        .search-bar input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text);
            font-size: 16px;
            outline: none;
        }

        .search-bar input::placeholder {
            color: var(--dim);
        }

        /* Cards */
        .card {
            background: var(--card);
            border-radius: 16px;
            overflow: hidden;
        }

        .card-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            text-decoration: none;
            color: inherit;
        }

        .card-item:last-child {
            border-bottom: none;
        }

        .card-item:active {
            background: #2c2c2e;
        }

        .item-image {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            background: #2c2c2e;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-title {
            font-size: 15px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-meta {
            font-size: 13px;
            color: var(--dim);
            margin-top: 2px;
        }

        .item-price {
            font-size: 15px;
            font-weight: 600;
            color: var(--green);
            margin-left: 8px;
        }

        .item-arrow {
            color: var(--dim);
            margin-left: 8px;
        }

        /* Key Dates */
        .date-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 4px 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .date-scroll::-webkit-scrollbar {
            display: none;
        }

        .date-card {
            flex-shrink: 0;
            width: 140px;
            background: var(--card);
            border-radius: 16px;
            padding: 16px;
        }

        .date-card .month {
            font-size: 11px;
            color: var(--red);
            text-transform: uppercase;
            font-weight: 600;
        }

        .date-card .day {
            font-size: 32px;
            font-weight: 700;
            margin: 4px 0;
        }

        .date-card .event {
            font-size: 13px;
            color: var(--dim);
            line-height: 1.3;
        }

        .date-card .tier {
            display: inline-block;
            font-size: 10px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 6px;
            margin-top: 8px;
            text-transform: uppercase;
        }

        .tier.peak { background: var(--red); }
        .tier.major { background: var(--orange); }
        .tier.medium { background: var(--accent); }
        .tier.minor { background: var(--dim); }

        /* Action Buttons */
        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 0 16px;
            margin-bottom: 24px;
        }

        .action-btn {
            padding: 16px;
            border-radius: 14px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.1s, opacity 0.1s;
        }

        .action-btn:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .action-btn.primary {
            background: var(--accent);
            color: #fff;
        }

        .action-btn.secondary {
            background: var(--card);
            color: var(--text);
        }

        .action-btn:disabled {
            opacity: 0.5;
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(28, 28, 30, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            padding: 12px 0 28px;
            border-top: 1px solid var(--border);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--dim);
            background: none;
            border: none;
            font-size: 10px;
            cursor: pointer;
            padding: 0 16px;
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
        }

        .nav-item.active {
            color: var(--accent);
        }

        /* Pages */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Empty State */
        .empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--dim);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 30px;
            color: var(--dim);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 60px;
            left: 16px;
            right: 16px;
            background: var(--card);
            color: var(--text);
            padding: 14px 20px;
            border-radius: 14px;
            text-align: center;
            font-size: 15px;
            transform: translateY(-120%);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Quick Search Chips */
        .chips {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 0 0 12px;
            -webkit-overflow-scrolling: touch;
        }

        .chips::-webkit-scrollbar {
            display: none;
        }

        .chip {
            flex-shrink: 0;
            padding: 8px 16px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
        }

        .chip.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 600;
            border-radius: 4px;
            margin-left: 6px;
            text-transform: uppercase;
        }

        .badge.auction { background: var(--orange); color: #000; }
        .badge.deal { background: var(--green); color: #000; }

        /* Clickable stat cards */
        .stat-card.clickable {
            cursor: pointer;
            transition: transform 0.15s, background 0.15s;
        }

        .stat-card.clickable:active {
            transform: scale(0.96);
            background: #2c2c2e;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--card);
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            border-radius: 20px 20px 0 0;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--dim);
            font-size: 28px;
            cursor: pointer;
            padding: 0 8px;
        }

        .modal-search {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .modal-search input {
            width: 100%;
            background: var(--bg);
            border: none;
            border-radius: 10px;
            padding: 12px 16px;
            color: var(--text);
            font-size: 15px;
            outline: none;
        }

        .modal-search input::placeholder {
            color: var(--dim);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Listing table rows */
        .listing-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            text-decoration: none;
            color: inherit;
        }

        .listing-row:active {
            background: #2c2c2e;
        }

        .listing-info {
            min-width: 0;
        }

        .listing-artist {
            font-size: 11px;
            color: var(--accent);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .listing-title {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin: 2px 0;
        }

        .listing-sku {
            font-size: 11px;
            color: var(--dim);
            font-family: monospace;
        }

        .listing-price {
            font-size: 16px;
            font-weight: 600;
            color: var(--green);
            text-align: right;
        }

        /* Pricing Modal Styles */
        .pricing-section {
            margin-bottom: 20px;
        }

        .pricing-label {
            display: block;
            font-size: 13px;
            color: var(--dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .category-checkbox {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--bg);
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .category-checkbox:active {
            background: #2c2c2e;
        }

        .category-checkbox input {
            display: none;
        }

        .category-checkbox .checkmark {
            width: 22px;
            height: 22px;
            border: 2px solid var(--dim);
            border-radius: 6px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .category-checkbox input:checked + .checkmark {
            background: var(--accent);
            border-color: var(--accent);
        }

        .category-checkbox input:checked + .checkmark::after {
            content: 'âœ“';
            color: #fff;
            font-size: 14px;
            font-weight: bold;
        }

        .category-checkbox .cat-name {
            font-size: 14px;
            flex: 1;
        }

        .category-checkbox .cat-count {
            font-size: 12px;
            color: var(--dim);
        }

        .adjustment-row {
            display: flex;
            gap: 10px;
        }

        .pricing-select {
            flex: 1;
            padding: 14px 16px;
            background: var(--bg);
            border: none;
            border-radius: 10px;
            color: var(--text);
            font-size: 15px;
            outline: none;
            cursor: pointer;
        }

        .pricing-input {
            width: 100px;
            padding: 14px 16px;
            background: var(--bg);
            border: none;
            border-radius: 10px;
            color: var(--text);
            font-size: 15px;
            outline: none;
            text-align: center;
        }

        .preview-box {
            background: var(--bg);
            border-radius: 12px;
            padding: 16px;
        }

        .preview-count {
            font-size: 14px;
            color: var(--dim);
            margin-bottom: 8px;
        }

        .preview-example {
            font-size: 13px;
            color: var(--text);
        }

        .preview-example .old-price {
            color: var(--dim);
            text-decoration: line-through;
            margin-right: 8px;
        }

        .preview-example .new-price {
            color: var(--green);
            font-weight: 600;
        }

        .preview-example .change {
            color: var(--accent);
            margin-left: 8px;
        }

        .pricing-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .pricing-actions .action-btn {
            flex: 1;
        }

        /* Calendar Month View */
        .calendar-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            margin-bottom: 16px;
        }

        .calendar-nav-btn {
            background: var(--card);
            border: none;
            color: var(--text);
            width: 44px;
            height: 44px;
            border-radius: 12px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-nav-btn:active {
            background: #2c2c2e;
        }

        .calendar-month-title {
            font-size: 20px;
            font-weight: 600;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            padding: 0 12px;
            margin-bottom: 20px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 11px;
            color: var(--dim);
            padding: 8px 0;
            text-transform: uppercase;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 6px 2px;
            border-radius: 10px;
            font-size: 14px;
            position: relative;
        }

        .calendar-day.other-month {
            color: var(--border);
        }

        .calendar-day.today {
            background: var(--card);
        }

        .calendar-day.today .day-num {
            background: var(--accent);
            color: #fff;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-day.has-event {
            cursor: pointer;
        }

        .calendar-day.has-event:active {
            background: var(--card);
        }

        .day-num {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .day-dots {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .day-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .day-dot.peak { background: var(--red); }
        .day-dot.major { background: var(--orange); }
        .day-dot.medium { background: var(--accent); }
        .day-dot.minor { background: var(--dim); }

        .month-events {
            padding: 0 16px;
        }

        .month-events-title {
            font-size: 13px;
            color: var(--dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .event-card {
            background: var(--card);
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .event-date {
            text-align: center;
            min-width: 44px;
        }

        .event-date .day {
            font-size: 24px;
            font-weight: 700;
            line-height: 1;
        }

        .event-date .month {
            font-size: 11px;
            color: var(--dim);
            text-transform: uppercase;
        }

        .event-details {
            flex: 1;
        }

        .event-name {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .event-item {
            font-size: 13px;
            color: var(--dim);
        }

        .event-boost {
            font-size: 14px;
            font-weight: 600;
            color: var(--green);
        }

        /* Underpriced Items */
        .underpriced-row {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            gap: 12px;
        }

        .underpriced-row:last-child {
            border-bottom: none;
        }

        .underpriced-info {
            flex: 1;
            min-width: 0;
        }

        .underpriced-event {
            font-size: 10px;
            color: var(--orange);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .underpriced-title {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin: 2px 0;
        }

        .underpriced-prices {
            text-align: right;
        }

        .underpriced-current {
            font-size: 13px;
            color: var(--dim);
            text-decoration: line-through;
        }

        .underpriced-suggested {
            font-size: 15px;
            font-weight: 600;
            color: var(--green);
        }

        .underpriced-boost {
            font-size: 11px;
            color: var(--orange);
            font-weight: 600;
        }

        /* Alert Items */
        .alert-row {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            gap: 12px;
            text-decoration: none;
            color: inherit;
        }

        .alert-row:last-child {
            border-bottom: none;
        }

        .alert-row:active {
            background: #2c2c2e;
        }

        .alert-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .alert-icon.low_price { background: var(--orange); }
        .alert-icon.high_price { background: var(--accent); }
        .alert-icon.update_failed { background: var(--red); }

        .alert-info {
            flex: 1;
            min-width: 0;
        }

        .alert-title {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .alert-message {
            font-size: 12px;
            color: var(--dim);
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Home Page -->
        <div class="page active" id="page-home">
            <div class="header">
                <h1>DATARADAR</h1>
                <div class="time" id="current-time"></div>
            </div>

            <div class="stats-grid">
                <div class="stat-card clickable" id="stat-listings-card" onclick="showListingsModal()">
                    <div class="value" id="stat-listings">--</div>
                    <div class="label">Listings</div>
                </div>
                <div class="stat-card green clickable" onclick="showPage('calendar')">
                    <div class="value" id="stat-rules">--</div>
                    <div class="label">Active</div>
                </div>
                <div class="stat-card orange clickable" onclick="showAlertsModal()">
                    <div class="value" id="stat-alerts">--</div>
                    <div class="label">Alerts</div>
                </div>
            </div>

            <div class="actions">
                <button class="action-btn primary" id="btn-pricing" onclick="showPricingModal()">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v2M4.93 4.93l2.83 2.83M14.24 14.24l2.83 2.83M2 12h4M18 12h2M4.93 19.07l2.83-2.83M14.24 7.76l2.83-2.83"/></svg>
                    Update Prices
                </button>
                <button class="action-btn secondary" id="btn-refresh">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                    Refresh
                </button>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Upcoming Events</h2>
                    <button class="section-action" onclick="showPage('calendar')">See All</button>
                </div>
                <div class="date-scroll" id="upcoming-dates">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Recent Listings</h2>
                    <button class="section-action" onclick="showPage('inventory')">See All</button>
                </div>
                <div class="card" id="recent-listings">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </div>

        <!-- Inventory Page -->
        <div class="page" id="page-inventory">
            <div class="header">
                <h1>Inventory</h1>
            </div>

            <div class="section">
                <div class="search-bar">
                    <svg fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                    <input type="text" id="inv-search" placeholder="Search listings...">
                </div>

                <div class="chips" id="inv-chips">
                    <button class="chip active" data-filter="all">All</button>
                    <button class="chip" data-filter="death nyc">Death NYC</button>
                    <button class="chip" data-filter="fairey">Shepard Fairey</button>
                    <button class="chip" data-filter="beatles">Beatles</button>
                    <button class="chip" data-filter="space">Space</button>
                </div>

                <div class="card" id="inv-results">
                    <div class="empty">Search for items</div>
                </div>
            </div>
        </div>

        <!-- Deals Page (Underpriced Inventory) -->
        <div class="page" id="page-deals">
            <div class="header">
                <h1>Underpriced</h1>
                <div class="time">Items to boost based on active events</div>
            </div>

            <div class="section">
                <div class="search-bar">
                    <svg fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                    <input type="text" id="underpriced-search" placeholder="Search underpriced items...">
                </div>

                <div id="underpriced-summary" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <span id="underpriced-count" style="color: var(--dim); font-size: 14px;">Loading...</span>
                    <button class="action-btn primary" id="boost-all-btn" onclick="boostAllUnderpriced()" style="padding: 10px 20px; font-size: 14px;">
                        Boost All
                    </button>
                </div>

                <div class="card" id="underpriced-results">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </div>

        <!-- Calendar Page -->
        <div class="page" id="page-calendar">
            <div class="header" style="padding-bottom: 10px;">
                <h1>Key Dates</h1>
            </div>

            <div class="calendar-nav">
                <button class="calendar-nav-btn" onclick="prevMonth()">â€¹</button>
                <span class="calendar-month-title" id="calendar-month-title">January 2026</span>
                <button class="calendar-nav-btn" onclick="nextMonth()">â€º</button>
            </div>

            <div class="calendar-grid" id="calendar-grid">
                <div class="calendar-day-header">Sun</div>
                <div class="calendar-day-header">Mon</div>
                <div class="calendar-day-header">Tue</div>
                <div class="calendar-day-header">Wed</div>
                <div class="calendar-day-header">Thu</div>
                <div class="calendar-day-header">Fri</div>
                <div class="calendar-day-header">Sat</div>
                <!-- Days will be populated by JS -->
            </div>

            <div class="month-events" id="month-events">
                <div class="month-events-title">Events This Month</div>
                <div id="events-list">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-page="home">
            <svg fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>
            Home
        </button>
        <button class="nav-item" data-page="inventory">
            <svg fill="none" stroke="currentColor" stroke-width="2"><path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
            Inventory
        </button>
        <button class="nav-item" data-page="deals">
            <svg fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
            Boost
        </button>
        <button class="nav-item" data-page="calendar">
            <svg fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
            Calendar
        </button>
    </nav>

    <div class="toast" id="toast"></div>

    <!-- Pricing Modal -->
    <div class="modal-overlay" id="pricing-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Update Prices by Category</h2>
                <button class="modal-close" onclick="closePricingModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 16px;">
                <div class="pricing-section">
                    <label class="pricing-label">Select Categories</label>
                    <div class="category-grid" id="category-checkboxes">
                        <!-- Categories will be populated dynamically -->
                    </div>
                </div>

                <div class="pricing-section">
                    <label class="pricing-label">Price Adjustment</label>
                    <div class="adjustment-row">
                        <select id="adjustment-type" class="pricing-select">
                            <option value="percent_increase">Increase by %</option>
                            <option value="percent_decrease">Decrease by %</option>
                            <option value="fixed_increase">Increase by $</option>
                            <option value="fixed_decrease">Decrease by $</option>
                            <option value="set_price">Set to $</option>
                        </select>
                        <input type="number" id="adjustment-value" class="pricing-input" placeholder="0" min="0" step="0.01">
                    </div>
                </div>

                <div class="pricing-section">
                    <label class="pricing-label">Preview</label>
                    <div class="preview-box" id="pricing-preview">
                        <div class="preview-count">0 items selected</div>
                        <div class="preview-example"></div>
                    </div>
                </div>

                <div class="pricing-actions">
                    <button class="action-btn secondary" onclick="closePricingModal()">Cancel</button>
                    <button class="action-btn primary" id="apply-pricing-btn" onclick="applyPricingChanges()">
                        Apply Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts Modal -->
    <div class="modal-overlay" id="alerts-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Alerts</h2>
                <button class="modal-close" onclick="closeAlertsModal()">&times;</button>
            </div>
            <div class="modal-body" id="alerts-list">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>
    </div>

    <!-- Price Edit Modal -->
    <div class="modal-overlay" id="price-edit-modal">
        <div class="modal" style="max-height: 60vh;">
            <div class="modal-header">
                <h2>Edit Price</h2>
                <button class="modal-close" onclick="closePriceEditModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 16px;">
                <div id="price-edit-item-title" style="font-size: 14px; color: var(--dim); margin-bottom: 16px;"></div>

                <div class="pricing-section">
                    <label class="pricing-label">Current Price</label>
                    <div id="price-edit-current" style="font-size: 18px; color: var(--dim); text-decoration: line-through;"></div>
                </div>

                <div class="pricing-section">
                    <label class="pricing-label">Suggested Price (+<span id="price-edit-boost">0</span>%)</label>
                    <div id="price-edit-suggested" style="font-size: 18px; color: var(--green); margin-bottom: 8px;"></div>
                </div>

                <div class="pricing-section">
                    <label class="pricing-label">New Price</label>
                    <input type="number" id="price-edit-input" class="pricing-input" style="width: 100%; text-align: left; font-size: 24px; padding: 16px;" step="0.01" min="0.99">
                </div>

                <div class="pricing-section" style="margin-top: 8px;">
                    <label class="pricing-label">Quick Adjust</label>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="chip" onclick="quickAdjustPrice(-10)">-$10</button>
                        <button class="chip" onclick="quickAdjustPrice(-5)">-$5</button>
                        <button class="chip" onclick="quickAdjustPrice(5)">+$5</button>
                        <button class="chip" onclick="quickAdjustPrice(10)">+$10</button>
                        <button class="chip" onclick="setToSuggested()">Suggested</button>
                    </div>
                </div>

                <div class="pricing-actions">
                    <button class="action-btn secondary" onclick="closePriceEditModal()">Cancel</button>
                    <button class="action-btn primary" id="price-edit-save-btn" onclick="savePriceEdit()">
                        Update on eBay
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Listings Modal -->
    <div class="modal-overlay" id="listings-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>All Listings</h2>
                <button class="modal-close" onclick="closeListingsModal()">&times;</button>
            </div>
            <div class="modal-search">
                <input type="text" id="modal-search" placeholder="Search listings..." oninput="filterModalListings()">
            </div>
            <div class="modal-body" id="modal-listings">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>
    </div>

    <script>
        // State
        let currentPage = 'home';
        let currentCat = 'all';
        let currentTier = 'all';
        let invFilter = 'all';
        let allListings = [];

        // Elements
        const toast = document.getElementById('toast');

        // Artist detection patterns
        const artistPatterns = [
            { pattern: /death\s*nyc/i, name: 'Death NYC' },
            { pattern: /shepard\s*fairey|obey\s*giant|obey/i, name: 'Shepard Fairey' },
            { pattern: /beatles|lennon|mccartney|harrison|ringo/i, name: 'Beatles' },
            { pattern: /warhol/i, name: 'Andy Warhol' },
            { pattern: /banksy/i, name: 'Banksy' },
            { pattern: /kaws/i, name: 'KAWS' },
            { pattern: /apollo|nasa|armstrong|aldrin|moon\s*landing/i, name: 'Space/NASA' },
            { pattern: /marilyn|monroe/i, name: 'Marilyn Monroe' },
            { pattern: /bowie/i, name: 'David Bowie' },
            { pattern: /elvis/i, name: 'Elvis Presley' },
            { pattern: /michael\s*jackson/i, name: 'Michael Jackson' },
            { pattern: /taylor\s*swift/i, name: 'Taylor Swift' },
            { pattern: /blink.?182/i, name: 'Blink 182' },
            { pattern: /green\s*day/i, name: 'Green Day' },
            { pattern: /nirvana|cobain/i, name: 'Nirvana' },
            { pattern: /queen|mercury/i, name: 'Queen' },
            { pattern: /grateful\s*dead|jerry\s*garcia/i, name: 'Grateful Dead' },
            { pattern: /rolling\s*stones|jagger/i, name: 'Rolling Stones' },
            { pattern: /hendrix/i, name: 'Jimi Hendrix' },
            { pattern: /prince/i, name: 'Prince' },
            { pattern: /star\s*wars/i, name: 'Star Wars' },
            { pattern: /disney|mickey/i, name: 'Disney' },
        ];

        function detectArtist(title) {
            for (const { pattern, name } of artistPatterns) {
                if (pattern.test(title)) return name;
            }
            return 'Art';
        }

        function extractTitle(fullTitle, artist) {
            // Remove common prefixes and the artist name
            let title = fullTitle
                .replace(/^(death\s*nyc|shepard\s*fairey|obey)\s*[-â€“â€”]\s*/i, '')
                .replace(/signed\s*(print|art|lithograph|poster)?\s*/i, '')
                .replace(/limited\s*edition\s*/i, '')
                .replace(/\s*[-â€“â€”]\s*signed.*$/i, '')
                .replace(/\s*w\/?coa.*$/i, '')
                .replace(/\s*\d+\/\d+\s*$/i, '')  // Remove edition numbers
                .trim();
            return title || fullTitle;
        }

        // Alerts Modal
        async function showAlertsModal() {
            const modal = document.getElementById('alerts-modal');
            const alertsList = document.getElementById('alerts-list');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';

            alertsList.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const resp = await fetch('/api/alerts');
                const alerts = await resp.json();

                if (!alerts.length) {
                    alertsList.innerHTML = '<div class="empty">No alerts - everything looks good!</div>';
                    return;
                }

                const icons = {
                    'low_price': 'ðŸ’°',
                    'high_price': 'ðŸ’Ž',
                    'update_failed': 'âš ï¸'
                };

                alertsList.innerHTML = alerts.map(alert => `
                    <a href="${alert.url}" target="_blank" class="alert-row">
                        <div class="alert-icon ${alert.type}">${icons[alert.type] || '!'}</div>
                        <div class="alert-info">
                            <div class="alert-title">${alert.title}</div>
                            <div class="alert-message">${alert.message}</div>
                        </div>
                        <span class="item-arrow">â€º</span>
                    </a>
                `).join('');
            } catch (e) {
                alertsList.innerHTML = '<div class="empty">Failed to load alerts</div>';
            }
        }

        function closeAlertsModal() {
            document.getElementById('alerts-modal').classList.remove('show');
            document.body.style.overflow = '';
        }

        document.getElementById('alerts-modal').addEventListener('click', (e) => {
            if (e.target.id === 'alerts-modal') closeAlertsModal();
        });

        // Modal functions
        async function showListingsModal() {
            const modal = document.getElementById('listings-modal');
            const modalBody = document.getElementById('modal-listings');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';

            modalBody.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const resp = await fetch('/api/search?q=');
                allListings = await resp.json();
                renderModalListings(allListings);
            } catch (e) {
                modalBody.innerHTML = '<div class="empty">Failed to load listings</div>';
            }
        }

        function closeListingsModal() {
            const modal = document.getElementById('listings-modal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
            document.getElementById('modal-search').value = '';
        }

        function filterModalListings() {
            const query = document.getElementById('modal-search').value.toLowerCase();
            const filtered = allListings.filter(item =>
                item.title.toLowerCase().includes(query) ||
                item.id.includes(query)
            );
            renderModalListings(filtered);
        }

        function renderModalListings(listings) {
            const modalBody = document.getElementById('modal-listings');

            if (!listings.length) {
                modalBody.innerHTML = '<div class="empty">No listings found</div>';
                return;
            }

            modalBody.innerHTML = listings.map(item => {
                const artist = detectArtist(item.title);
                const artTitle = extractTitle(item.title, artist);
                const sku = item.id.replace(/^v1\|/, '').split('|')[0];

                return `
                    <a href="${item.url}" target="_blank" class="listing-row">
                        <div class="listing-info">
                            <div class="listing-artist">${artist}</div>
                            <div class="listing-title">${artTitle}</div>
                            <div class="listing-sku">SKU: ${sku}</div>
                        </div>
                        <div class="listing-price">$${item.price.toFixed(2)}</div>
                    </a>
                `;
            }).join('');
        }

        // Close modal on overlay click
        document.getElementById('listings-modal').addEventListener('click', (e) => {
            if (e.target.id === 'listings-modal') closeListingsModal();
        });

        // Pricing Modal Functions
        let pricingListings = [];
        let categoryData = {};

        async function showPricingModal() {
            const modal = document.getElementById('pricing-modal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';

            // Load listings if not already loaded
            if (!allListings.length) {
                try {
                    const resp = await fetch('/api/search?q=');
                    allListings = await resp.json();
                } catch (e) {
                    showToast('Failed to load listings');
                    return;
                }
            }

            pricingListings = [...allListings];

            // Build category counts
            categoryData = {};
            for (const item of pricingListings) {
                const cat = detectArtist(item.title);
                if (!categoryData[cat]) {
                    categoryData[cat] = { count: 0, items: [] };
                }
                categoryData[cat].count++;
                categoryData[cat].items.push(item);
            }

            // Sort by count descending
            const sortedCats = Object.entries(categoryData)
                .sort((a, b) => b[1].count - a[1].count);

            // Render category checkboxes
            document.getElementById('category-checkboxes').innerHTML = sortedCats.map(([cat, data]) => `
                <label class="category-checkbox">
                    <input type="checkbox" value="${cat}" onchange="updatePricingPreview()">
                    <span class="checkmark"></span>
                    <span class="cat-name">${cat}</span>
                    <span class="cat-count">${data.count}</span>
                </label>
            `).join('');

            // Reset form
            document.getElementById('adjustment-type').value = 'percent_increase';
            document.getElementById('adjustment-value').value = '';
            updatePricingPreview();
        }

        function closePricingModal() {
            document.getElementById('pricing-modal').classList.remove('show');
            document.body.style.overflow = '';
        }

        document.getElementById('pricing-modal').addEventListener('click', (e) => {
            if (e.target.id === 'pricing-modal') closePricingModal();
        });

        // Update preview when inputs change
        document.getElementById('adjustment-type')?.addEventListener('change', updatePricingPreview);
        document.getElementById('adjustment-value')?.addEventListener('input', updatePricingPreview);

        function updatePricingPreview() {
            const checkboxes = document.querySelectorAll('#category-checkboxes input:checked');
            const selectedCats = Array.from(checkboxes).map(cb => cb.value);
            const adjustType = document.getElementById('adjustment-type').value;
            const adjustValue = parseFloat(document.getElementById('adjustment-value').value) || 0;

            // Count selected items
            let selectedItems = [];
            for (const cat of selectedCats) {
                if (categoryData[cat]) {
                    selectedItems = selectedItems.concat(categoryData[cat].items);
                }
            }

            const previewDiv = document.getElementById('pricing-preview');
            const countText = `${selectedItems.length} item${selectedItems.length !== 1 ? 's' : ''} selected`;

            if (selectedItems.length === 0 || adjustValue === 0) {
                previewDiv.innerHTML = `
                    <div class="preview-count">${countText}</div>
                    <div class="preview-example" style="color: var(--dim);">Select categories and enter an adjustment value</div>
                `;
                return;
            }

            // Calculate example
            const exampleItem = selectedItems[0];
            const oldPrice = exampleItem.price;
            let newPrice = oldPrice;
            let changeText = '';

            switch (adjustType) {
                case 'percent_increase':
                    newPrice = oldPrice * (1 + adjustValue / 100);
                    changeText = `+${adjustValue}%`;
                    break;
                case 'percent_decrease':
                    newPrice = oldPrice * (1 - adjustValue / 100);
                    changeText = `-${adjustValue}%`;
                    break;
                case 'fixed_increase':
                    newPrice = oldPrice + adjustValue;
                    changeText = `+$${adjustValue.toFixed(2)}`;
                    break;
                case 'fixed_decrease':
                    newPrice = oldPrice - adjustValue;
                    changeText = `-$${adjustValue.toFixed(2)}`;
                    break;
                case 'set_price':
                    newPrice = adjustValue;
                    changeText = `set to $${adjustValue.toFixed(2)}`;
                    break;
            }

            newPrice = Math.max(0.99, newPrice); // Min price $0.99

            previewDiv.innerHTML = `
                <div class="preview-count">${countText}</div>
                <div class="preview-example">
                    Example: <span class="old-price">$${oldPrice.toFixed(2)}</span>
                    <span class="new-price">$${newPrice.toFixed(2)}</span>
                    <span class="change">(${changeText})</span>
                </div>
            `;
        }

        async function applyPricingChanges() {
            const checkboxes = document.querySelectorAll('#category-checkboxes input:checked');
            const selectedCats = Array.from(checkboxes).map(cb => cb.value);
            const adjustType = document.getElementById('adjustment-type').value;
            const adjustValue = parseFloat(document.getElementById('adjustment-value').value) || 0;

            if (selectedCats.length === 0) {
                showToast('Select at least one category');
                return;
            }

            if (adjustValue === 0) {
                showToast('Enter an adjustment value');
                return;
            }

            // Get items to update
            let itemsToUpdate = [];
            for (const cat of selectedCats) {
                if (categoryData[cat]) {
                    itemsToUpdate = itemsToUpdate.concat(categoryData[cat].items);
                }
            }

            const btn = document.getElementById('apply-pricing-btn');
            btn.disabled = true;
            btn.textContent = `Updating ${itemsToUpdate.length} items...`;

            try {
                const resp = await fetch('/api/update-category-pricing', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        item_ids: itemsToUpdate.map(i => i.id),
                        adjustment_type: adjustType,
                        adjustment_value: adjustValue
                    })
                });

                const data = await resp.json();

                if (data.success) {
                    showToast(`Updated ${data.updated} items, ${data.failed} failed`);
                    closePricingModal();
                    loadStats();
                    // Clear cache so next listing view shows new prices
                    allListings = [];
                } else {
                    showToast(data.error || 'Update failed');
                }
            } catch (e) {
                showToast('Update failed');
            }

            btn.disabled = false;
            btn.textContent = 'Apply Changes';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateTime();
            setInterval(updateTime, 60000);
            loadStats();
            loadRecentListings();
            loadUpcomingDates();
        });

        // Time display
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent =
                now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        }

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => showPage(item.dataset.page));
        });

        function showPage(page) {
            currentPage = page;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`page-${page}`).classList.add('active');
            document.querySelector(`[data-page="${page}"]`).classList.add('active');

            if (page === 'calendar') loadCalendar();
            if (page === 'inventory') loadInventory();
            if (page === 'deals') loadUnderpriced();
        }

        // Load all inventory items
        async function loadInventory() {
            const resultsDiv = document.getElementById('inv-results');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const resp = await fetch('/api/search?q=');
                let items = await resp.json();
                allListings = items;

                // Apply filter if set
                if (invFilter !== 'all') {
                    items = items.filter(i => i.title.toLowerCase().includes(invFilter));
                }

                renderInventory(items);
            } catch (e) {
                resultsDiv.innerHTML = '<div class="empty">Failed to load inventory</div>';
            }
        }

        function renderInventory(items) {
            const resultsDiv = document.getElementById('inv-results');

            if (!items.length) {
                resultsDiv.innerHTML = '<div class="empty">No items found</div>';
                return;
            }

            resultsDiv.innerHTML = items.map(item => {
                const artist = detectArtist(item.title);
                return `
                    <a href="${item.url}" target="_blank" class="card-item">
                        <img src="${item.image || ''}" class="item-image" onerror="this.style.visibility='hidden'">
                        <div class="item-info">
                            <div class="listing-artist">${artist}</div>
                            <div class="item-title">${item.title}</div>
                        </div>
                        <div class="item-price">$${item.price.toFixed(2)}</div>
                        <span class="item-arrow">â€º</span>
                    </a>
                `;
            }).join('');
        }

        // Stats
        async function loadStats() {
            try {
                const resp = await fetch('/api/stats');
                const data = await resp.json();
                document.getElementById('stat-listings').textContent = data.listings;
                document.getElementById('stat-rules').textContent = data.rules;
                document.getElementById('stat-alerts').textContent = data.alerts;
            } catch (e) {
                console.error('Stats error:', e);
            }
        }

        // Recent Listings
        async function loadRecentListings() {
            try {
                const resp = await fetch('/api/search?q=');
                const items = await resp.json();
                renderListings(items.slice(0, 5), 'recent-listings');
            } catch (e) {
                document.getElementById('recent-listings').innerHTML = '<div class="empty">Failed to load</div>';
            }
        }

        // Upcoming Dates - fetches from API
        async function loadUpcomingDates() {
            try {
                const resp = await fetch('/api/upcoming-dates');
                const dates = await resp.json();

                if (!dates.length) {
                    document.getElementById('upcoming-dates').innerHTML = '<div class="empty" style="padding:20px;width:100%">No upcoming events</div>';
                    return;
                }

                document.getElementById('upcoming-dates').innerHTML = dates.map(d => `
                    <div class="date-card">
                        <div class="month">${d.month}</div>
                        <div class="day">${d.day}</div>
                        <div class="event">${d.event}</div>
                        <span class="tier ${d.tier}">${d.tier}</span>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Upcoming dates error:', e);
                document.getElementById('upcoming-dates').innerHTML = '<div class="empty" style="padding:20px">Failed to load</div>';
            }
        }

        // Render listings helper
        function renderListings(items, containerId) {
            const container = document.getElementById(containerId);
            if (!items.length) {
                container.innerHTML = '<div class="empty">No items found</div>';
                return;
            }
            container.innerHTML = items.map(item => `
                <a href="${item.url}" target="_blank" class="card-item">
                    <img src="${item.image || ''}" class="item-image" onerror="this.style.visibility='hidden'">
                    <div class="item-info">
                        <div class="item-title">${item.title}</div>
                        <div class="item-meta">${item.condition || ''}</div>
                    </div>
                    <div class="item-price">$${item.price.toFixed(2)}</div>
                    <span class="item-arrow">â€º</span>
                </a>
            `).join('');
        }

        // Inventory search
        const invSearch = document.getElementById('inv-search');
        let invTimeout;
        invSearch.addEventListener('input', () => {
            clearTimeout(invTimeout);
            invTimeout = setTimeout(() => searchInventory(invSearch.value), 300);
        });

        document.querySelectorAll('#inv-chips .chip').forEach(chip => {
            chip.addEventListener('click', () => {
                document.querySelectorAll('#inv-chips .chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                invFilter = chip.dataset.filter;
                searchInventory(invSearch.value);
            });
        });

        async function searchInventory(query) {
            document.getElementById('inv-results').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            try {
                // Use cached listings if available, otherwise fetch
                let items = allListings.length ? [...allListings] : [];
                if (!items.length) {
                    const resp = await fetch('/api/search?q=');
                    items = await resp.json();
                    allListings = items;
                }

                // Apply search filter
                if (query) {
                    items = items.filter(i => i.title.toLowerCase().includes(query.toLowerCase()));
                }

                // Apply category filter
                if (invFilter !== 'all') {
                    items = items.filter(i => i.title.toLowerCase().includes(invFilter));
                }

                renderInventory(items);
            } catch (e) {
                document.getElementById('inv-results').innerHTML = '<div class="empty">Search failed</div>';
            }
        }

        // Underpriced Items
        let underpricedItems = [];

        async function loadUnderpriced() {
            const resultsDiv = document.getElementById('underpriced-results');
            const countSpan = document.getElementById('underpriced-count');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const resp = await fetch('/api/underpriced');
                underpricedItems = await resp.json();

                if (underpricedItems.length === 0) {
                    countSpan.textContent = 'No underpriced items';
                    document.getElementById('boost-all-btn').style.display = 'none';
                } else {
                    const totalPotential = underpricedItems.reduce((sum, item) =>
                        sum + (item.suggested_price - item.current_price), 0);
                    countSpan.textContent = `${underpricedItems.length} items (+$${totalPotential.toFixed(2)} potential)`;
                    document.getElementById('boost-all-btn').style.display = 'block';
                }

                renderUnderpriced(underpricedItems);
            } catch (e) {
                console.error('Underpriced error:', e);
                resultsDiv.innerHTML = '<div class="empty">Failed to load underpriced items</div>';
                countSpan.textContent = 'Error loading';
            }
        }

        function renderUnderpriced(items) {
            const container = document.getElementById('underpriced-results');

            if (!items.length) {
                container.innerHTML = '<div class="empty">All items are priced correctly for current events</div>';
                return;
            }

            container.innerHTML = items.map((item, index) => `
                <div class="underpriced-row" onclick="openPriceEdit(${index})" style="cursor: pointer;">
                    <div class="underpriced-info">
                        <div class="underpriced-event">${item.event} (+${item.boost_percent}%)</div>
                        <div class="underpriced-title">${item.title}</div>
                    </div>
                    <div class="underpriced-prices">
                        <div class="underpriced-current">$${item.current_price.toFixed(2)}</div>
                        <div class="underpriced-suggested">$${item.suggested_price.toFixed(2)}</div>
                    </div>
                    <span class="item-arrow">â€º</span>
                </div>
            `).join('');
        }

        // Search underpriced items
        const underpricedSearch = document.getElementById('underpriced-search');
        if (underpricedSearch) {
            let underpricedTimeout;
            underpricedSearch.addEventListener('input', () => {
                clearTimeout(underpricedTimeout);
                underpricedTimeout = setTimeout(() => {
                    const query = underpricedSearch.value.toLowerCase();
                    const filtered = underpricedItems.filter(item =>
                        item.title.toLowerCase().includes(query) ||
                        item.event.toLowerCase().includes(query)
                    );
                    renderUnderpriced(filtered);
                }, 300);
            });
        }

        // Price Edit Modal
        let currentEditItem = null;
        let currentEditIndex = -1;

        function openPriceEdit(index) {
            currentEditIndex = index;
            currentEditItem = underpricedItems[index];

            document.getElementById('price-edit-item-title').textContent = currentEditItem.title;
            document.getElementById('price-edit-current').textContent = `$${currentEditItem.current_price.toFixed(2)}`;
            document.getElementById('price-edit-suggested').textContent = `$${currentEditItem.suggested_price.toFixed(2)}`;
            document.getElementById('price-edit-boost').textContent = currentEditItem.boost_percent;
            document.getElementById('price-edit-input').value = currentEditItem.suggested_price.toFixed(2);

            document.getElementById('price-edit-modal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closePriceEditModal() {
            document.getElementById('price-edit-modal').classList.remove('show');
            document.body.style.overflow = '';
            currentEditItem = null;
            currentEditIndex = -1;
        }

        document.getElementById('price-edit-modal').addEventListener('click', (e) => {
            if (e.target.id === 'price-edit-modal') closePriceEditModal();
        });

        function quickAdjustPrice(amount) {
            const input = document.getElementById('price-edit-input');
            let currentVal = parseFloat(input.value) || 0;
            currentVal = Math.max(0.99, currentVal + amount);
            input.value = currentVal.toFixed(2);
        }

        function setToSuggested() {
            if (currentEditItem) {
                document.getElementById('price-edit-input').value = currentEditItem.suggested_price.toFixed(2);
            }
        }

        async function savePriceEdit() {
            if (!currentEditItem) return;

            const newPrice = parseFloat(document.getElementById('price-edit-input').value);
            if (!newPrice || newPrice < 0.99) {
                showToast('Invalid price');
                return;
            }

            const btn = document.getElementById('price-edit-save-btn');
            btn.disabled = true;
            btn.textContent = 'Updating...';

            try {
                const resp = await fetch('/api/update-category-pricing', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        item_ids: [currentEditItem.id],
                        adjustment_type: 'set_price',
                        adjustment_value: newPrice
                    })
                });

                const data = await resp.json();

                if (data.updated > 0) {
                    showToast(`Updated to $${newPrice.toFixed(2)}`);
                    closePriceEditModal();

                    // Update the item in our local list
                    if (currentEditIndex >= 0) {
                        underpricedItems[currentEditIndex].current_price = newPrice;
                        // Remove from list if price matches suggested
                        if (Math.abs(newPrice - underpricedItems[currentEditIndex].suggested_price) < 0.01) {
                            underpricedItems.splice(currentEditIndex, 1);
                        }
                        renderUnderpriced(underpricedItems);

                        // Update count
                        const countSpan = document.getElementById('underpriced-count');
                        if (underpricedItems.length === 0) {
                            countSpan.textContent = 'No underpriced items';
                            document.getElementById('boost-all-btn').style.display = 'none';
                        } else {
                            const totalPotential = underpricedItems.reduce((sum, item) =>
                                sum + (item.suggested_price - item.current_price), 0);
                            countSpan.textContent = `${underpricedItems.length} items (+$${totalPotential.toFixed(2)} potential)`;
                        }
                    }

                    loadStats();
                } else {
                    showToast('Update failed');
                }
            } catch (e) {
                showToast('Update failed');
            }

            btn.disabled = false;
            btn.textContent = 'Update on eBay';
        }

        async function boostAllUnderpriced() {
            if (!underpricedItems.length) {
                showToast('No items to boost');
                return;
            }

            const btn = document.getElementById('boost-all-btn');
            btn.disabled = true;
            btn.textContent = `Boosting ${underpricedItems.length}...`;

            try {
                // Group items by boost percent and update
                let updated = 0;
                let failed = 0;

                // Update each item to its suggested price
                for (const item of underpricedItems) {
                    try {
                        const resp = await fetch('/api/update-category-pricing', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                item_ids: [item.id],
                                adjustment_type: 'set_price',
                                adjustment_value: item.suggested_price
                            })
                        });

                        const data = await resp.json();
                        if (data.updated > 0) updated++;
                        else failed++;
                    } catch (e) {
                        failed++;
                    }
                }

                showToast(`Boosted ${updated} items, ${failed} failed`);

                // Refresh the list
                loadUnderpriced();
                loadStats();
            } catch (e) {
                showToast('Boost failed');
            }

            btn.disabled = false;
            btn.textContent = 'Boost All';
        }

        // Calendar Month View
        let calendarData = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];

        function prevMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendarMonth();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendarMonth();
        }

        async function loadCalendar() {
            document.getElementById('events-list').innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const resp = await fetch('/api/calendar?all=true');
                calendarData = await resp.json();
                renderCalendarMonth();
            } catch (e) {
                console.error('Calendar error:', e);
                document.getElementById('events-list').innerHTML = '<div class="empty">Failed to load calendar</div>';
            }
        }

        function renderCalendarMonth() {
            const monthTitle = document.getElementById('calendar-month-title');
            const grid = document.getElementById('calendar-grid');
            const eventsList = document.getElementById('events-list');

            monthTitle.textContent = `${monthNames[currentMonth]} ${currentYear}`;

            // Clear existing days (keep headers)
            const headers = grid.querySelectorAll('.calendar-day-header');
            grid.innerHTML = '';
            headers.forEach(h => grid.appendChild(h));

            // Get first day of month and total days
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();

            // Build events map for this month
            const eventsMap = {};
            const monthEvents = [];

            calendarData.forEach(event => {
                const startDate = new Date(event.start_date);
                const endDate = new Date(event.end_date);

                // Check if event overlaps with current month
                const monthStart = new Date(currentYear, currentMonth, 1);
                const monthEnd = new Date(currentYear, currentMonth + 1, 0);

                if (startDate <= monthEnd && endDate >= monthStart) {
                    monthEvents.push(event);

                    // Mark each day in the event range
                    for (let d = new Date(Math.max(startDate, monthStart)); d <= Math.min(endDate, monthEnd); d.setDate(d.getDate() + 1)) {
                        if (d.getMonth() === currentMonth) {
                            const dayNum = d.getDate();
                            if (!eventsMap[dayNum]) eventsMap[dayNum] = [];
                            if (!eventsMap[dayNum].find(e => e.event === event.event)) {
                                eventsMap[dayNum].push(event);
                            }
                        }
                    }
                }
            });

            const today = new Date();
            const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;

            // Add previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                grid.innerHTML += `<div class="calendar-day other-month"><span class="day-num">${day}</span></div>`;
            }

            // Add current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = isCurrentMonth && day === today.getDate();
                const dayEvents = eventsMap[day] || [];
                const hasEvent = dayEvents.length > 0;

                let dotsHtml = '';
                if (hasEvent) {
                    // Show up to 3 dots for different tier events
                    const uniqueTiers = [...new Set(dayEvents.map(e => e.tier.toLowerCase()))].slice(0, 3);
                    dotsHtml = `<div class="day-dots">${uniqueTiers.map(t => `<span class="day-dot ${t}"></span>`).join('')}</div>`;
                }

                grid.innerHTML += `
                    <div class="calendar-day${isToday ? ' today' : ''}${hasEvent ? ' has-event' : ''}"
                         ${hasEvent ? `onclick="showDayEvents(${day})"` : ''}>
                        <span class="day-num">${day}</span>
                        ${dotsHtml}
                    </div>
                `;
            }

            // Add next month days to fill grid
            const totalCells = firstDay + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 1; i <= remainingCells; i++) {
                grid.innerHTML += `<div class="calendar-day other-month"><span class="day-num">${i}</span></div>`;
            }

            // Render month events list
            if (!monthEvents.length) {
                eventsList.innerHTML = '<div class="empty">No events this month</div>';
                return;
            }

            // Sort by start date
            monthEvents.sort((a, b) => new Date(a.start_date) - new Date(b.start_date));

            eventsList.innerHTML = monthEvents.map(e => {
                const start = new Date(e.start_date);
                return `
                    <div class="event-card">
                        <div class="event-date">
                            <div class="day">${start.getDate()}</div>
                            <div class="month">${monthNames[start.getMonth()].slice(0, 3)}</div>
                        </div>
                        <div class="event-details">
                            <div class="event-name">${e.event}</div>
                            <div class="event-item">${e.item}</div>
                        </div>
                        <div class="event-boost">+${e.increase}%</div>
                    </div>
                `;
            }).join('');
        }

        function showDayEvents(day) {
            // Show events for a specific day with price boost
            const dayEvents = calendarData.filter(e => {
                const start = new Date(e.start_date);
                const end = new Date(e.end_date);
                const checkDate = new Date(currentYear, currentMonth, day);
                return checkDate >= start && checkDate <= end;
            });

            if (dayEvents.length) {
                const eventDetails = dayEvents.map(e => `${e.event} (+${e.increase}%)`).join(' | ');
                showToast(`${monthNames[currentMonth]} ${day}: ${eventDetails}`);
            }
        }

        // Actions
        document.getElementById('btn-pricing').addEventListener('click', async () => {
            const btn = document.getElementById('btn-pricing');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;margin:0"></div> Updating...';

            try {
                const resp = await fetch('/api/run-pricing', { method: 'POST' });
                const data = await resp.json();
                showToast(`Updated ${data.updated} items`);
                loadStats();
            } catch (e) {
                showToast('Update failed');
            }

            btn.disabled = false;
            btn.innerHTML = '<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v2M4.93 4.93l2.83 2.83M14.24 14.24l2.83 2.83M2 12h4M18 12h2M4.93 19.07l2.83-2.83M14.24 7.76l2.83-2.83"/></svg> Update Prices';
        });

        document.getElementById('btn-refresh').addEventListener('click', async () => {
            const btn = document.getElementById('btn-refresh');
            btn.disabled = true;

            try {
                await fetch('/api/refresh');
                showToast('Refreshed');
                loadStats();
                loadRecentListings();
            } catch (e) {
                showToast('Refresh failed');
            }

            btn.disabled = false;
        });

        // Toast
        function showToast(msg) {
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }
    </script>
</body>
</html>
